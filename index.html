<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>LatteStream WebRTC Diagnostic</title>
<style>
  video { width: 45%; margin: 5px; background: black; }
  #log { white-space: pre-wrap; background: #222; color: #0f0; padding: 10px; height: 300px; overflow-y: scroll; }
</style>
</head>
<body>
<h2>Видеозвонок через LatteStream сигнализацию 222</h2>
<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>
<div id="log">Диагностическая информация будет здесь…</div>

<script>
const logDiv = document.getElementById('log');
function log(msg, type="info") {
    const time = new Date().toLocaleTimeString();
    logDiv.textContent += `[${time}] ${msg}\n`;
    logDiv.scrollTop = logDiv.scrollHeight;
}

// Настройки LatteStream
const PUBLIC_KEY = "lspk_Z2w6ZjViZWE5MTUtZjAxZC00ZDcxLTllZGEtMDA2ZTFlNDBkODU1OjI1ZmEwNWUyLTY4ZWQtNGVjYi04ZDJmLTY1NTU2YTExOTIzZA";
const CHANNEL = "webrtc-channel";  // Название канала
const WSS_URL = `wss://ws.lattestream.com/?appKey=${PUBLIC_KEY}&channel=${CHANNEL}`;

// Проверка URL соединения
log(`Проверяем WSS URL: ${WSS_URL}`);
let ws;
try {
    ws = new WebSocket(WSS_URL);
} catch(e) {
    log(`Ошибка при создании WebSocket: ${e}`, "error");
}

ws.onopen = () => log("WebSocket соединение открыто");
ws.onerror = (e) => log(`WebSocket ошибка: type=${e.type}, isTrusted=${e.isTrusted}`, "error");
ws.onclose = (e) => log(`WebSocket закрыт. Код: ${e.code}, причина: ${e.reason}, wasClean: ${e.wasClean}`, "error");
ws.onmessage = (msg) => log(`Получено сообщение: ${msg.data}`);

// WebRTC
const pc = new RTCPeerConnection({
    iceServers: [{urls: "stun:stun.l.google.com:19302"}]
});

pc.onicecandidate = (event) => {
    if (event.candidate) {
        log(`Отправлен ICE-кандидат: ${JSON.stringify(event.candidate)}`);
        ws.send(JSON.stringify({type: 'ice', candidate: event.candidate}));
    } else {
        log("Все ICE-кандидаты отправлены.");
    }
};

pc.onconnectionstatechange = () => log(`Состояние соединения: ${pc.connectionState}`);
pc.oniceconnectionstatechange = () => log(`Состояние ICE: ${pc.iceConnectionState}`);

const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

// Получаем медиа
navigator.mediaDevices.getUserMedia({video: true, audio: true})
.then(stream => {
    localVideo.srcObject = stream;
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
    log("Камера и микрофон подключены.");
    createOffer();
}).catch(err => log(`Ошибка доступа к медиа: ${err}`, "error"));

async function createOffer() {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    log("Оффер создан и установлен локально.");
    if(ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({type: 'offer', sdp: offer.sdp}));
        log("Оффер отправлен через сигнализацию.");
    } else {
        log("WebSocket не открыт, оффер не отправлен.", "error");
    }
}

// Принятие сообщений от сигнального сервера
ws.onmessage = async (event) => {
    log(`Получено сообщение: ${event.data}`);
    const data = JSON.parse(event.data);
    if(data.type === 'answer') {
        await pc.setRemoteDescription({type: 'answer', sdp: data.sdp});
        log("Ответ установлен как удаленное описание.");
    } else if(data.type === 'ice') {
        await pc.addIceCandidate(data.candidate);
        log(`ICE-кандидат добавлен: ${JSON.stringify(data.candidate)}`);
    }
};

pc.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
    log("Удаленное видео подключено.");
};
</script>
</body>
</html>
