<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>WebRTC P2P с WebSocket</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; }
  video { width: 45%; margin: 10px; border: 1px solid black; }
  button { margin: 5px; padding: 10px 20px; font-size: 16px; }
</style>
</head>
<body>

<h2>Видеозвонок через WebSocket</h2>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<button id="startBtn">Начать звонок</button>

<script>
const WS_SERVER = "wss://demo.piesocket.com/v3/channel_1?api_key=demo"; // публичный бесплатный WebSocket
const ws = new WebSocket(WS_SERVER);

const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const startBtn = document.getElementById("startBtn");

let localStream;

// Отображение удаленного потока
pc.ontrack = event => { remoteVideo.srcObject = event.streams[0]; };

// Отправка ICE-кандидатов через WebSocket
pc.onicecandidate = event => {
  if(event.candidate){
    ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
  }
};

// Обработка сообщений WebSocket
ws.onmessage = async (msg) => {
  const data = JSON.parse(msg.data);
  if(data.type === "offer"){
    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ type: "answer", answer }));
  } else if(data.type === "answer"){
    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
  } else if(data.type === "candidate"){
    try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } 
    catch(e){ console.error(e); }
  }
};

// ====== Запуск камеры и звонка ======
startBtn.onclick = async () => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: "offer", offer }));
    startBtn.disabled = true;
    startBtn.textContent = "Звонок активен";
  } catch(e){
    alert("Ошибка доступа к камере/микрофону: " + e);
  }
};
</script>

</body>
</html>
